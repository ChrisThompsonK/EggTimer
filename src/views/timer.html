<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egg Timer</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/timer.css">
</head>
<body class="timer-page">
    <div class="container">
        <h1>ðŸ¥š Egg Timer</h1>
        
        <div class="timer-options">
            <button class="timer-option" onclick="startTimer(180)">
                Soft Boiled<br><small>3 minutes</small>
            </button>
            <button class="timer-option" onclick="startTimer(360)">
                Medium Boiled<br><small>6 minutes</small>
            </button>
            <button class="timer-option" onclick="startTimer(480)">
                Hard Boiled<br><small>8 minutes</small>
            </button>
            <button class="timer-option" onclick="startTimer(600)">
                Well Done<br><small>10 minutes</small>
            </button>
        </div>

        <div class="custom-timer">
            <h3>ðŸŽ¯ Custom Timer</h3>
            <div class="time-inputs">
                <div>
                    <input type="number" class="time-input" id="hours" min="0" max="23" value="0">
                    <div class="time-label">hours</div>
                </div>
                <div>
                    <input type="number" class="time-input" id="minutes" min="0" max="59" value="0">
                    <div class="time-label">minutes</div>
                </div>
                <div>
                    <input type="number" class="time-input" id="seconds" min="0" max="59" value="30">
                    <div class="time-label">seconds</div>
                </div>
            </div>
            <button class="start-custom" onclick="startCustomTimer()">Start Custom Timer</button>
        </div>

        <div class="timer-display" id="timerDisplay">
            <div class="timer-circle">
                <div class="timer-ring">
                    <div class="timer-progress" id="timerProgress"></div>
                </div>
                <div class="timer-text" id="timerText">00:00</div>
            </div>
            
            <div class="timer-controls">
                <button class="control-btn pause-btn" onclick="pauseTimer()">Pause</button>
                <button class="control-btn stop-btn" onclick="stopTimer()">Stop</button>
            </div>
        </div>

        <div class="notification" id="notification"></div>

        <div class="navigation">
            <a href="/about" class="nav-link">ðŸ“– About</a>
        </div>
    </div>

    <script>
        let currentTimerId = null;
        let isPaused = false;
        let totalDuration = 0;
        let remainingTime = 0;

        async function startTimer(duration) {
            try {
                showTimer();
                totalDuration = duration;
                remainingTime = duration;
                
                const response = await fetch('/api/timers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ duration })
                });

                if (!response.ok) {
                    throw new Error('Failed to start timer');
                }

                const timer = await response.json();
                currentTimerId = timer.id;
                
                updateTimerDisplay();
                showNotification('Timer started!', 'success');
                
            } catch (error) {
                console.error('Error starting timer:', error);
                showNotification('Failed to start timer', 'error');
            }
        }

        function startCustomTimer() {
            const hours = parseInt(document.getElementById('hours').value) || 0;
            const minutes = parseInt(document.getElementById('minutes').value) || 0;
            const seconds = parseInt(document.getElementById('seconds').value) || 0;
            
            const duration = hours * 3600 + minutes * 60 + seconds;
            
            if (duration <= 0) {
                showNotification('Please set a valid time', 'error');
                return;
            }
            
            startTimer(duration);
        }

        async function pauseTimer() {
            if (!currentTimerId) return;
            
            try {
                const action = isPaused ? 'resume' : 'pause';
                const response = await fetch(`/api/timers/${currentTimerId}/${action}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Failed to ${action} timer`);
                }

                isPaused = !isPaused;
                const pauseBtn = document.querySelector('.pause-btn');
                pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
                
                showNotification(isPaused ? 'Timer paused' : 'Timer resumed', 'success');
                
            } catch (error) {
                console.error('Error pausing/resuming timer:', error);
                showNotification('Failed to pause/resume timer', 'error');
            }
        }

        async function stopTimer() {
            if (!currentTimerId) return;
            
            try {
                const response = await fetch(`/api/timers/${currentTimerId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to stop timer');
                }

                resetTimer();
                showNotification('Timer stopped', 'success');
                
            } catch (error) {
                console.error('Error stopping timer:', error);
                showNotification('Failed to stop timer', 'error');
            }
        }

        function showTimer() {
            document.getElementById('timerDisplay').style.display = 'block';
            const pauseBtn = document.querySelector('.pause-btn');
            pauseBtn.textContent = 'Pause';
            isPaused = false;
        }

        function resetTimer() {
            document.getElementById('timerDisplay').style.display = 'none';
            currentTimerId = null;
            isPaused = false;
            totalDuration = 0;
            remainingTime = 0;
            
            // Reset progress ring
            const progress = document.getElementById('timerProgress');
            progress.style.transform = 'rotate(-90deg)';
        }

        function updateTimerDisplay() {
            if (!currentTimerId || isPaused) return;
            
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timerText').textContent = timeText;
            
            // Update progress ring
            const progress = (totalDuration - remainingTime) / totalDuration;
            const degrees = progress * 360 - 90;
            document.getElementById('timerProgress').style.transform = `rotate(${degrees}deg)`;
            
            if (remainingTime <= 0) {
                showNotification('Time\'s up! ðŸ””', 'success');
                resetTimer();
                return;
            }
            
            remainingTime--;
            setTimeout(updateTimerDisplay, 1000);
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Check timer status on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/timers');
                if (response.ok) {
                    const timers = await response.json();
                    if (timers.length > 0) {
                        // Resume existing timer if any
                        const activeTimer = timers.find(t => t.status === 'running' || t.status === 'paused');
                        if (activeTimer) {
                            currentTimerId = activeTimer.id;
                            remainingTime = activeTimer.remainingTime;
                            totalDuration = activeTimer.duration;
                            isPaused = activeTimer.status === 'paused';
                            showTimer();
                            if (!isPaused) {
                                updateTimerDisplay();
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking timer status:', error);
            }
        });
    </script>
</body>
</html>
