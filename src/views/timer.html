<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egg Timer</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/timer.css">
</head>
<body class="timer-page">
    <div class="container">
        <h1>ðŸ¥š Egg Timer</h1>
        
        <div class="timer-options">
            <button class="timer-option" onclick="startTimer(180)">
                Soft Boiled<br><small>3 minutes</small>
            </button>
            <button class="timer-option" onclick="startTimer(360)">
                Medium Boiled<br><small>6 minutes</small>
            </button>
            <button class="timer-option" onclick="startTimer(480)">
                Hard Boiled<br><small>8 minutes</small>
            </button>
            <button class="timer-option" onclick="startTimer(600)">
                Well Done<br><small>10 minutes</small>
            </button>
        </div>

        <div class="custom-timer">
            <h3>ðŸŽ¯ Custom Timer</h3>
            <div class="slider-container">
                <div class="slider-group">
                    <label class="slider-label">Hours: <span id="hoursValue">0</span></label>
                    <div class="slider-track">
                        <input type="range" class="slider hours-slider" id="hoursSlider" min="0" max="23" value="0" step="1">
                        <div class="slider-thumb" data-slider="hours"></div>
                        <div class="slider-fill hours-fill" data-slider="hours"></div>
                    </div>
                </div>
                
                <div class="slider-group">
                    <label class="slider-label">Minutes: <span id="minutesValue">0</span></label>
                    <div class="slider-track">
                        <input type="range" class="slider minutes-slider" id="minutesSlider" min="0" max="59" value="0" step="1">
                        <div class="slider-thumb" data-slider="minutes"></div>
                        <div class="slider-fill minutes-fill" data-slider="minutes"></div>
                    </div>
                </div>
                
                <div class="slider-group">
                    <label class="slider-label">Seconds: <span id="secondsValue">30</span></label>
                    <div class="slider-track">
                        <input type="range" class="slider seconds-slider" id="secondsSlider" min="0" max="59" value="30" step="1">
                        <div class="slider-thumb" data-slider="seconds"></div>
                        <div class="slider-fill seconds-fill" data-slider="seconds"></div>
                    </div>
                </div>
            </div>
            
            <div class="time-display">
                <span id="totalTimeDisplay">00:00:30</span>
            </div>
            
            <button class="start-custom" onclick="startCustomTimer()">
                <span class="btn-text">Start Custom Timer</span>
                <span class="btn-glow"></span>
            </button>
        </div>

        <div class="timer-display" id="timerDisplay">
            <div class="timer-circle">
                <div class="timer-ring">
                    <div class="timer-progress" id="timerProgress"></div>
                </div>
                <div class="timer-text" id="timerText">00:00</div>
            </div>
            
            <div class="timer-controls">
                <button class="control-btn pause-btn" onclick="pauseTimer()">Pause</button>
                <button class="control-btn stop-btn" onclick="stopTimer()">Stop</button>
            </div>
        </div>

        <div class="notification" id="notification"></div>

        <div class="navigation">
            <a href="/about" class="nav-link">ðŸ“– About</a>
        </div>
    </div>

    <script>
        let currentTimerId = null;
        let isPaused = false;
        let totalDuration = 0;
        let remainingTime = 0;

        async function startTimer(duration) {
            try {
                showTimer();
                totalDuration = duration;
                remainingTime = duration;
                
                const response = await fetch('/api/timers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ duration })
                });

                if (!response.ok) {
                    throw new Error('Failed to start timer');
                }

                const timer = await response.json();
                currentTimerId = timer.id;
                
                updateTimerDisplay();
                showNotification('Timer started!', 'success');
                
            } catch (error) {
                console.error('Error starting timer:', error);
                showNotification('Failed to start timer', 'error');
            }
        }

        function startCustomTimer() {
            const hours = parseInt(document.getElementById('hoursSlider').value) || 0;
            const minutes = parseInt(document.getElementById('minutesSlider').value) || 0;
            const seconds = parseInt(document.getElementById('secondsSlider').value) || 0;
            
            const duration = hours * 3600 + minutes * 60 + seconds;
            
            if (duration <= 0) {
                showNotification('Please set a valid time', 'error');
                return;
            }
            
            startTimer(duration);
        }

        // Slider functionality
        function initializeSliders() {
            const sliders = ['hours', 'minutes', 'seconds'];
            
            sliders.forEach(type => {
                const slider = document.getElementById(`${type}Slider`);
                const valueDisplay = document.getElementById(`${type}Value`);
                const thumb = document.querySelector(`.slider-thumb[data-slider="${type}"]`);
                const fill = document.querySelector(`.slider-fill[data-slider="${type}"]`);
                
                function updateSlider() {
                    const value = parseInt(slider.value);
                    const max = parseInt(slider.max);
                    const percentage = (value / max) * 100;
                    
                    valueDisplay.textContent = value;
                    thumb.style.left = `${percentage}%`;
                    fill.style.width = `${percentage}%`;
                    
                    updateTotalTimeDisplay();
                }
                
                slider.addEventListener('input', updateSlider);
                slider.addEventListener('mousedown', () => {
                    thumb.classList.add('active');
                });
                
                slider.addEventListener('mouseup', () => {
                    thumb.classList.remove('active');
                });
                
                // Initialize position
                updateSlider();
            });
        }
        
        function updateTotalTimeDisplay() {
            const hours = parseInt(document.getElementById('hoursSlider').value) || 0;
            const minutes = parseInt(document.getElementById('minutesSlider').value) || 0;
            const seconds = parseInt(document.getElementById('secondsSlider').value) || 0;
            
            const totalDisplay = document.getElementById('totalTimeDisplay');
            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            totalDisplay.textContent = formattedTime;
        }

        async function pauseTimer() {
            if (!currentTimerId) return;
            
            const pauseBtn = document.querySelector('.pause-btn');
            pauseBtn.classList.add('btn-state-change');
            
            try {
                const action = isPaused ? 'resume' : 'pause';
                const response = await fetch(`/api/timers/${currentTimerId}/${action}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Failed to ${action} timer`);
                }

                isPaused = !isPaused;
                
                // Smooth state transition
                if (isPaused) {
                    pauseBtn.textContent = 'Resume';
                    pauseBtn.classList.add('paused');
                    document.querySelector('.timer-circle').classList.remove('active');
                    showNotification('Timer paused â¸ï¸', 'success');
                } else {
                    pauseBtn.textContent = 'Pause';
                    pauseBtn.classList.remove('paused');
                    document.querySelector('.timer-circle').classList.add('active');
                    showNotification('Timer resumed â–¶ï¸', 'success');
                    updateTimerDisplay();
                }
                
            } catch (error) {
                console.error('Error pausing/resuming timer:', error);
                showNotification('Failed to pause/resume timer', 'error');
            } finally {
                setTimeout(() => pauseBtn.classList.remove('btn-state-change'), 300);
            }
        }

        async function stopTimer() {
            if (!currentTimerId) return;
            
            const stopBtn = document.querySelector('.stop-btn');
            stopBtn.classList.add('btn-state-change');
            
            try {
                const response = await fetch(`/api/timers/${currentTimerId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to stop timer');
                }

                // Smooth exit animation
                const timerDisplay = document.getElementById('timerDisplay');
                timerDisplay.style.animation = 'fadeOutDown 0.5s ease-in forwards';
                
                setTimeout(() => {
                    resetTimer();
                    timerDisplay.style.animation = '';
                }, 500);
                
                showNotification('Timer stopped ðŸ›‘', 'success');
                
            } catch (error) {
                console.error('Error stopping timer:', error);
                showNotification('Failed to stop timer', 'error');
            } finally {
                setTimeout(() => stopBtn.classList.remove('btn-state-change'), 300);
            }
        }

        function showTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timerCircle = document.querySelector('.timer-circle');
            timerDisplay.style.display = 'block';
            timerCircle.classList.add('active');
            
            const pauseBtn = document.querySelector('.pause-btn');
            pauseBtn.textContent = 'Pause';
            isPaused = false;
        }

        function resetTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timerCircle = document.querySelector('.timer-circle');
            const timerProgress = document.getElementById('timerProgress');
            const timerText = document.getElementById('timerText');
            
            timerDisplay.style.display = 'none';
            timerCircle.classList.remove('active');
            timerProgress.classList.remove('normal', 'warning', 'critical');
            timerText.classList.remove('warning', 'critical');
            
            currentTimerId = null;
            isPaused = false;
            totalDuration = 0;
            remainingTime = 0;
            
            // Reset progress ring
            timerProgress.style.background = '';
            timerProgress.style.animation = '';
            timerProgress.style.transform = 'rotate(-90deg)';
        }

        function updateTimerDisplay() {
            if (!currentTimerId || isPaused) return;
            
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerTextElement = document.getElementById('timerText');
            const timerProgress = document.getElementById('timerProgress');
            
            timerTextElement.textContent = timeText;
            
            // Update timer states based on remaining time percentage
            const remainingPercentage = (remainingTime / totalDuration) * 100;
            const completionPercentage = ((totalDuration - remainingTime) / totalDuration) * 100;
            
            // Remove existing state classes
            timerProgress.classList.remove('normal', 'warning', 'critical');
            timerTextElement.classList.remove('warning', 'critical');
            
            // Apply appropriate state classes and colors
            if (remainingPercentage <= 10) {
                // Critical state (red, fast animations)
                timerProgress.classList.add('critical');
                timerTextElement.classList.add('critical');
            } else if (remainingPercentage <= 25) {
                // Warning state (orange, medium animations)
                timerProgress.classList.add('warning');
                timerTextElement.classList.add('warning');
            } else {
                // Normal state (green, gentle animations)
                timerProgress.classList.add('normal');
            }
            
            // Create dynamic background based on completion with smooth color transitions
            const angle = 360 - (completionPercentage * 3.6);
            let colorStops;
            
            if (remainingPercentage <= 10) {
                colorStops = `
                    transparent 0deg, 
                    transparent ${angle}deg,
                    #ef5350 ${angle}deg,
                    #f44336 ${angle + 45}deg,
                    #e53935 ${angle + 90}deg,
                    #d32f2f 360deg
                `;
            } else if (remainingPercentage <= 25) {
                colorStops = `
                    transparent 0deg, 
                    transparent ${angle}deg,
                    #ffa726 ${angle}deg,
                    #ff9800 ${angle + 45}deg,
                    #ff8f00 ${angle + 90}deg,
                    #e65100 360deg
                `;
            } else {
                colorStops = `
                    transparent 0deg, 
                    transparent ${angle}deg,
                    #66bb6a ${angle}deg,
                    #4caf50 ${angle + 45}deg,
                    #43a047 ${angle + 90}deg,
                    #2e7d32 360deg
                `;
            }
            
            timerProgress.style.background = `conic-gradient(from 270deg, ${colorStops})`;
            
            if (remainingTime <= 0) {
                showNotification('Time\'s up! ðŸ””', 'success');
                // Add completion animation
                timerProgress.style.animation = 'completionFlash 1s ease-in-out';
                setTimeout(() => {
                    resetTimer();
                }, 1000);
                return;
            }
            
            remainingTime--;
            setTimeout(updateTimerDisplay, 1000);
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            
            // Clear any existing animation classes
            notification.classList.remove('show', 'success', 'error');
            
            // Set content and type
            notification.textContent = message;
            notification.classList.add(type);
            
            // Show with animation
            notification.style.display = 'block';
            
            // Trigger animation on next frame
            requestAnimationFrame(() => {
                notification.classList.add('show');
            });
            
            // Hide after delay
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.classList.remove(type);
                }, 400);
            }, 3000);
        }

        // Check timer status on page load
        window.addEventListener('load', async () => {
            // Initialize sliders
            initializeSliders();
            
            try {
                const response = await fetch('/api/timers');
                if (response.ok) {
                    const timers = await response.json();
                    if (timers.length > 0) {
                        // Resume existing timer if any
                        const activeTimer = timers.find(t => t.status === 'running' || t.status === 'paused');
                        if (activeTimer) {
                            currentTimerId = activeTimer.id;
                            remainingTime = activeTimer.remainingTime;
                            totalDuration = activeTimer.duration;
                            isPaused = activeTimer.status === 'paused';
                            showTimer();
                            if (!isPaused) {
                                updateTimerDisplay();
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking timer status:', error);
            }
        });
    </script>
</body>
</html>
